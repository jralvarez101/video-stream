<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>Recording in process</title>
  </head>
  <body>
    <h1>Recording in process</h1>

    <video
      src=""
      id="previewVideo"
      style="width: 680px; height: 320px;"
      autoplay="true"
    ></video>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
    <canvas id="preview"></canvas>
    <script type="text/javascript">
      (function (exports, d) {
        function domReady(fn, context) {
          function onReady(event) {
            d.removeEventListener("DOMContentLoaded", onReady);
            fn.call(context || exports, event);
          }

          function onReadyIe(event) {
            if (d.readyState === "complete") {
              d.detachEvent("onreadystatechange", onReadyIe);
              fn.call(context || exports, event);
            }
          }

          (d.addEventListener &&
            d.addEventListener("DOMContentLoaded", onReady)) ||
            (d.attachEvent && d.attachEvent("onreadystatechange", onReadyIe));
        }

        exports.domReady = domReady;
      })(window, document);

      var canvas = document.getElementById("preview");
      var context = canvas.getContext("2d");
      const HEIGHT = 320;
      const WIDTH = 680;

      canvas.width = WIDTH;
      canvas.height = HEIGHT;

      context.width = WIDTH;
      context.height = HEIGHT;

      var previewVideo = document.getElementById("previewVideo");
      const socket = io.connect("192.168.1.8:3000");

      function loadCam(stream) {
        previewVideo.srcObject = stream;
        previewVideo.play();
      }
      function loadFail() {
        console.log("load failed");
      }

      function viewVideo(video, context) {
        context.drawImage(video, 0, 0, WIDTH, HEIGHT);
        socket.emit("stream", canvas.toDataURL("image/webp"));
      }

      domReady(function (event) {
        navigator.getUserMedia =
          navigator.getUserMedia ||
          navigator.webkitGetUserMedia ||
          navigator.mozGetUserMedia ||
          navigator.msgGetUserMedia;
        if (navigator.getUserMedia) {
          navigator.getUserMedia({ video: true }, loadCam, loadFail);
        }

        setInterval(() => {
          viewVideo(previewVideo, context);
        }, 50);
      });
    </script>
  </body>
</html>
